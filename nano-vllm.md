# nano-vllm
## vllm
å¯ä»¥æ¯”ç›´æ¥è°ƒç”¨æ¨¡å‹çš„generateé€Ÿåº¦å¿«24å€
å‰é¢è®²äº†KVcacheæé«˜äº†è®¡ç®—é€Ÿåº¦ï¼Œä½†æ˜¯æµªè´¹äº†å¤§é‡çš„å†…å­˜ã€‚
![alt text](0c42f11b4b0adf0771f6bfe03ddcdb9e.jpg)
1. å¤§æ¨¡å‹ä¸çŸ¥é“ä¼šç”Ÿæˆå¤šå°‘ç»™token
2. ç”Ÿæˆç¬¬ä¸€ä¸ªçš„æ—¶å€™åé¢çš„ç©ºé—´å·²ç»åˆ†é…å¥½äº†ï¼Œæœ¬æ¥å¯ä»¥å¹¶è¡Œå¤„ç†ï¼Œä½†æ˜¯ç°åœ¨å› ä¸ºé¢„åˆ†é…å¤§å¤§å‡æ…¢æ•ˆç‡
3. ç¢ç‰‡ï¼ˆç¥­ç¥–è¯¾ï¼‰
vllmå°±æ˜¯æ¥è§£å†³è¿™ä¸ªæµªè´¹é—®é¢˜çš„ï¼ï¼ï¼ˆè®©èƒ½å¤Ÿå¹¶è¡Œå¤„ç†çš„batchï¼ˆæ‰¹æ¬¡ï¼‰å˜å¤§ï¼Œæé«˜ååé‡ï¼Œä¹Ÿè®©å•ä½æ—¶é—´å†…è¾“å‡ºå˜å¤šï¼‰ï¼Œåšçš„ä¼˜åŒ–å¦‚ä¸‹ï¼š
1. Page Attention
![alt text](e9775e998bc7b913fa79212dd9bd1b5d.jpg)
æ“ä½œç³»ç»Ÿé‡Œé¢æŠŠç‰©ç†å†…å­˜åˆ†ä¸ºå¾ˆå¤šä¸ªä¸åŒçš„é¡µï¼Œç„¶åè¿›è¡Œæ˜ å°„ï¼Œæ¥æé«˜åˆ©ç”¨ç‡ï¼Œæ‰€ä»¥è¿™é‡ŒKVcacheä¹ŸæŒ‰ç…§KVblockçš„å¤§å°è¿›è¡Œåˆ†å¼€ï¼Œç„¶åè¿›è¡Œæ˜ å°„ï¼Œè¿™æ ·æœ¬æ¥æ˜¯ç›¸é‚»çš„tokenæ˜ å°„ä»¥åä¹Ÿä¸éœ€è¦éå¾—è¿ç€ï¼Œæœ‰å¯èƒ½ä¹Ÿåœ¨ä¸åŒçš„å—é‡Œé¢äº†ï¼Œè€Œä¸”è¿™æ ·ä»¥å—ä¸ºå•ä½ï¼Œå°±ç®—æµªè´¹ä¹Ÿåªä¼šæµªè´¹ä¸‰ä¸ªï¼Œä¸ä¼šåƒä»¥å‰ä¸€æ ·æµªè´¹é‚£ä¹ˆå¤š
![alt text](c92cba32e7db9f077c8a014014d534a4.jpg)
![alt text](67a02ec0b58547b826b26b619077551d.jpg)
![alt text](0bb633fdb2d524437eab151a969e08d1.jpg)
![alt text](0aa59a483285e98acf76812ef2ea1513.jpg)
é€šè¿‡è¿™ç§æŠŠé€»è¾‘æ˜¾å­˜æ˜ å°„åˆ°ç‰©ç†æ˜¾å­˜çš„æ–¹å¼ï¼Œè®©åŸæœ¬éœ€è¦ç´§æŒ¨åœ¨ä¸€èµ·çš„å˜å¾—å¯ä»¥åˆ†å¼€ï¼Œè€Œä¸”è®©ç¨‹åºæ„Ÿè§‰è‡ªå·±ç”¨çš„æ˜¯ä¸€æ•´ç‰‡è¿ç»­çš„ç©ºé—´ã€‚vllmé€šè¿‡ç®¡ç†è¿™ä¸ªè¡¨ï¼Œå°±å¯ä»¥å®Œæˆæ˜ å°„äº†
2. Sharing KV Blocks
 ![alt text](a241c7d4f5c893b63ddb4140af3e1eaa.jpg)
 ![alt text](42e9fa1ccff06726b151fb9d779e069e.jpg)
## ä»£ç å®ç°æ€»ç»“
æ ¸å¿ƒä»»åŠ¡ï¼šè°ƒåº¦ç®—æ³• (Scheduling)
æœ¬æ¬¡ä½œä¸šçš„ç›®æ ‡æ˜¯å°†é»˜è®¤çš„ FCFS (å…ˆæ¥ååˆ°) è°ƒåº¦æ”¹ä¸º SJF (çŸ­ä½œä¸šä¼˜å…ˆ)ã€‚

1. ç†è®ºå¯¹æ¯”
FCFS (First-Come First-Served):

é€»è¾‘ï¼šè°å…ˆæ’é˜Ÿè°å…ˆåƒã€‚

ç¼ºç‚¹ï¼šå¦‚æœæœ‰é•¿ä»»åŠ¡ï¼ˆå¤§ä½œä¸šï¼‰æ’åœ¨å‰é¢ï¼Œåé¢æ‰€æœ‰çŸ­ä»»åŠ¡éƒ½è¦ç­‰å¾ˆä¹…ï¼ˆæŠ¤èˆªæ•ˆåº”ï¼‰ã€‚

SJF (Shortest Job First):

é€»è¾‘ï¼šä¸ç®¡è°å…ˆæ¥ï¼Œé˜Ÿåˆ—é‡Œè°çš„ä»»åŠ¡æœ€çŸ­ï¼ˆToken æœ€å°‘ï¼‰ï¼Œè°å…ˆåƒã€‚

ä¼˜ç‚¹ï¼šå¤§å¹…é™ä½å¹³å‡ç­‰å¾…æ—¶é—´ã€‚

ç¼ºç‚¹ï¼šé¥¥é¥¿ (Starvation)ã€‚å¦‚æœçŸ­ä»»åŠ¡æºæºä¸æ–­ï¼Œé•¿ä»»åŠ¡å¯èƒ½æ°¸è¿œè½®ä¸åˆ°æ‰§è¡Œã€‚
```python
def schedule(self) -> tuple[list[Sequence], bool]:
        # prefill
        scheduled_seqs = []
        num_seqs = 0
        num_batched_tokens = 0

        # =========== SJF æ ¸å¿ƒä¿®æ”¹ä»£ç  ===========
        if self.waiting:
            # 1. æ’åºï¼šæŒ‰ Prompt é•¿åº¦ (len(x)) ä»å°åˆ°å¤§æ’åº
            # è¿™æ ·çŸ­ä»»åŠ¡å°±ä¼šè·‘åˆ°é˜Ÿä¼æœ€å‰é¢ (ç´¢å¼•0)
            sorted_waiting = sorted(self.waiting, key=lambda x: len(x))
            
            # 2. æ›´æ–°é˜Ÿåˆ—ï¼šæŠŠæ’å¥½åºçš„åˆ—è¡¨å˜å› deque
            self.waiting = deque(sorted_waiting)
            
            # (å¯é€‰) è°ƒè¯•æ‰“å°ï¼Œç”¨äºéªŒè¯é•¿çŸ­é¡ºåº
            # print(f"ğŸ‘‰ [ç›‘æ§] æ­£åœ¨è°ƒåº¦ä»»åŠ¡ï¼Œé•¿åº¦ä¸º: {len(self.waiting[0])}")
        # ======================================

        while self.waiting and num_seqs < self.max_num_seqs:
            # ... åŸæœ‰é€»è¾‘ä¸å˜ ... ```
æˆ‘ä»¬ç¼–å†™äº†ä¸€ä¸ªæµ‹è¯•è„šæœ¬ï¼Œæ•…æ„å…ˆæäº¤é•¿ä»»åŠ¡ï¼Œå†æäº¤çŸ­ä»»åŠ¡ï¼Œè§‚å¯Ÿç³»ç»Ÿæ˜¯å¦ä¼šè‡ªåŠ¨â€œæ’é˜Ÿâ€ã€‚è™½ç„¶é•¿åº¦ä¸º 7 çš„ä»»åŠ¡æ˜¯ç¬¬ 2 ä¸ªæäº¤çš„ï¼Œä½†å®ƒç¬¬ 1 ä¸ªè¢«å¤„ç†ã€‚è¯æ˜ SJF æˆåŠŸç”Ÿæ•ˆã€‚

##
å‚æ•°,å«ä¹‰,é€šä¿—ç†è§£
max_num_batched_tokens,æœ€å¤§æ‰¹å¤„ç† Token æ•°,æ¡Œå­çš„æœ€å¤§æ‰¿é‡ï¼Œä¸€æ¬¡ä¸èƒ½ç«¯å¤ªå¤šç›˜å­ã€‚
max_num_seqs,æœ€å¤§å¹¶å‘åºåˆ—æ•°,é¤å…çš„åº§ä½æ•°ï¼Œåæ»¡äº†å°±ä¸è®©è¿›äººäº†ã€‚
gpu_memory_utilization,æ˜¾å­˜å ç”¨ç‡ (0.9),éœ¸é“æ¨¡å¼ï¼Œå¯åŠ¨æ—¶ç›´æ¥åœˆå  90% æ˜¾å­˜ã€‚
kvcache_block_size,KV Cache å—å¤§å°,æ˜¾å­˜åˆ†é¡µçš„â€œé¡µå¤§å°â€ï¼ŒPagedAttention çš„åŸºç¡€ã€‚
2. Eager Mode vs CUDA Graph
ä½œä¸šä¸­ä½¿ç”¨äº† enforce_eager=Trueã€‚

Eager Mode (å¼ºåˆ¶å¼€å¯)ï¼šä¸€æ­¥ä¸€åŠ¨ï¼Œè§£é‡Šæ‰§è¡Œã€‚

ä¼˜ç‚¹ï¼šçµæ´»ï¼Œæ”¯æŒå˜é•¿æ•°æ®ï¼ˆé€‚åˆ SJF è¿™ç§ä¹±åºåœºæ™¯ï¼‰ï¼Œæ–¹ä¾¿è°ƒè¯•ã€‚

ç¼ºç‚¹ï¼šç¨å¾®æ…¢ä¸€ç‚¹ç‚¹ã€‚

CUDA Graphï¼šæå‰å½•åˆ¶ï¼Œæ•´å›¾æ‰§è¡Œã€‚

ç‰¹ç‚¹ï¼šæå¿«ï¼Œä½†è¦æ±‚è¾“å…¥å½¢çŠ¶å›ºå®šã€‚å› ä¸º SJF å¯¼è‡´æ¯æ¬¡è¿›æ¥çš„ä»»åŠ¡æ•°é‡å’Œå½¢çŠ¶ä¸å›ºå®šï¼Œæ‰€ä»¥æœ¬æ¬¡ä½œä¸šä¸é€‚åˆç”¨å®ƒã€‚